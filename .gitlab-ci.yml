default:
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  before_script:
    - docker info
    - echo -n ${CI_JOB_TOKEN} | docker login -u ${CI_REGISTRY_USER} --password-stdin ${CI_REGISTRY}

stages:
- build

variables:
  DOCKER_DRIVER: overlay2

build-stable:
  stage: build
  variables:
      DOCKER_IMAGE_NAME: $CI_REGISTRY_IMAGE
      DOCKER_IMAGE_TAG:  bookworm
  script:
    - docker pull ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} || true
    - docker buildx --cache-from ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} --platform linux/amd64 --build-arg=DEBIAN_RELEASE=${_DEBIAN_RELEASE}-slim .
    - docker push ${DOCKER_IMAGE_NAME}:$CI_COMMIT_SHA
    - docker push ${DOCKER_IMAGE_NAME}:latest
    - docker push ${DOCKER_IMAGE_NAME}:stable
    - docker push ${CONTAINER_RELEASE_IMAGE}

build-oldstable:
  stage: build
  variables:
      DOCKER_IMAGE_NAME: $CI_REGISTRY_IMAGE
      DOCKER_IMAGE_TAG:  bullseye
  script:
    - docker pull ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} || true
    - docker build --cache-from ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} --platform linux/arm64/v8,linux/amd64 --build-arg=DEBIAN_RELEASE=${_DEBIAN_RELEASE}-slim .
    - docker push ${DOCKER_IMAGE_NAME}:$CI_COMMIT_SHA
    - docker push ${DOCKER_IMAGE_NAME}:oldstable
    - docker push ${CONTAINER_RELEASE_IMAGE}

