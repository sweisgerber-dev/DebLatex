default:
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  before_script:
    - docker info
    - echo -n ${CI_JOB_TOKEN} | docker login -u ${CI_REGISTRY_USER} --password-stdin ${CI_REGISTRY}
    - docker context create general
    - docker buildx create general --use

stages:
- build

variables:
  DOCKER_DRIVER: overlay2

build-stable:
  stage: build
  variables:
      DOCKER_IMAGE_NAME: $CI_REGISTRY_IMAGE
      DOCKER_IMAGE_TAG:  bookworm
  script:
    - docker pull ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} || true
    - docker buildx build --cache-from ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} --tag ${CI_COMMIT_REF_SLUG} --platform linux/arm64/v8,linux/amd64 --build-arg=DEBIAN_RELEASE=${DOCKER_IMAGE_TAG}-slim .
    - docker push ${DOCKER_IMAGE_NAME}:${CI_COMMIT_REF_SLUG}
    - docker push ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}
    - docker push ${DOCKER_IMAGE_NAME}:stable
    - docker push ${DOCKER_IMAGE_NAME}:latest

build-oldstable:
  stage: build
  variables:
      DOCKER_IMAGE_NAME: $CI_REGISTRY_IMAGE
      DOCKER_IMAGE_TAG:  bullseye
  script:
    - docker pull ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} || true
    - docker buildx build --cache-from ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} --tag ${CI_COMMIT_REF_SLUG} --platform linux/arm64/v8,linux/amd64 --build-arg=DEBIAN_RELEASE=${DOCKER_IMAGE_TAG}-slim .
    - docker push ${DOCKER_IMAGE_NAME}:${CI_COMMIT_REF_SLUG}
    - docker push ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}
    - docker push ${DOCKER_IMAGE_NAME}:oldstable
